name: Build & Deploy via SFTP (Vite)

on:
  push:
    branches: [ main ]

env:
  HOST: 178.16.136.31
  PORT: 65002
  USER: u447731851
  TARGET_DIR: /home/u447731851/www   # <-- change if your remote path differs
  ARTIFACT: dist

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies & build (Vite)
        run: |
          npm ci
          npm run build

      - name: Show built artifact (debug)
        run: |
          echo "Artifact dir: $ARTIFACT"
          if [ -d "$ARTIFACT" ]; then
            echo "$ARTIFACT exists; listing:"
            ls -la $ARTIFACT || true
            find $ARTIFACT -type f -print | sed -n '1,200p'
          else
            echo "ERROR: $ARTIFACT not found" >&2
            exit 1
          fi

      - name: Decode private key (from base64 secret)
        run: |
          echo "$SFTP_KEY_B64" | base64 -d > /tmp/sftp_key
          chmod 600 /tmp/sftp_key
        env:
          SFTP_KEY_B64: ${{ secrets.SFTP_KEY_B64 }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p $PORT $HOST >> ~/.ssh/known_hosts || true
          chmod 644 ~/.ssh/known_hosts

      - name: SSH debug test (verbose)
        run: |
          ssh -i /tmp/sftp_key -p $PORT -o BatchMode=yes -o StrictHostKeyChecking=yes -vvv $USER@$HOST "echo SSH_OK" || true
        env:
          HOST: ${{ env.HOST }}
          PORT: ${{ env.PORT }}
          USER: ${{ env.USER }}

      - name: Deploy via SFTP (appleboy/scp-action)
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.HOST }}
          username: ${{ env.USER }}
          port: ${{ env.PORT }}
          key_path: /tmp/sftp_key
          source: "${{ env.ARTIFACT }}/"
          target: ${{ env.TARGET_DIR }}
          overwrite: true
