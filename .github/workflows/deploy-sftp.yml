name: Build & Deploy via SFTP (Vite) - fixed key path + connectivity test

on:
  push:
    branches: [ main ]

env:
  HOST: 178.16.136.31
  PORT: 65002
  USER: u447731851
  TARGET_DIR: /home/u447731851/www
  ARTIFACT: dist

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies & build
        run: |
          npm ci
          npm run build

      - name: Show built artifact (debug)
        run: |
          echo "Artifact dir: $ARTIFACT"
          if [ -d "$ARTIFACT" ]; then
            echo "$ARTIFACT exists; listing:"
            ls -la $ARTIFACT || true
            find $ARTIFACT -type f -print | sed -n '1,200p'
          else
            echo "ERROR: $ARTIFACT not found" >&2
            exit 1
          fi

      - name: Decode private key into workspace (accessible to docker)
        run: |
          mkdir -p $GITHUB_WORKSPACE/.ssh
          echo "$SFTP_KEY_B64" | base64 -d > $GITHUB_WORKSPACE/.ssh/sftp_key
          chmod 600 $GITHUB_WORKSPACE/.ssh/sftp_key
        env:
          SFTP_KEY_B64: ${{ secrets.SFTP_KEY_B64 }}

      - name: Connectivity test: can runner reach host:port?
        id: conn
        run: |
          echo "Testing TCP connectivity to $HOST:$PORT (timeout 10s)..."
          # bash /dev/tcp works on ubuntu runners
          timeout 10 bash -c 'cat < /dev/tcp/'"$HOST/$PORT" > /dev/null 2>&1 && echo "OPEN" || echo "CLOSED"' > /tmp/tcp_status || true
          cat /tmp/tcp_status
          if grep -q "OPEN" /tmp/tcp_status; then
            echo "host_reachable=true" >> $GITHUB_OUTPUT
          else
            echo "host_reachable=false" >> $GITHUB_OUTPUT
          fi

      - name: Abort early if host unreachable
        if: steps.conn.outputs.host_reachable == 'false'
        run: |
          echo "ERROR: Runner cannot reach $HOST:$PORT. This is a network/connectivity issue (firewall, host down, or port blocked)."
          echo "Check Hostinger firewall or try a self-hosted runner in your network."
          exit 1

      - name: Add server to known_hosts (so dockerized action won't prompt)
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p $PORT $HOST >> ~/.ssh/known_hosts || true
          chmod 644 ~/.ssh/known_hosts

      - name: SSH debug test (verbose) - runner -> server
        run: |
          ssh -i $GITHUB_WORKSPACE/.ssh/sftp_key -p $PORT -o BatchMode=yes -o StrictHostKeyChecking=yes -vvv $USER@$HOST "echo SSH_OK" || true
        env:
          HOST: ${{ env.HOST }}
          PORT: ${{ env.PORT }}
          USER: ${{ env.USER }}

      - name: Deploy via SFTP (appleboy/scp-action)
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.HOST }}
          username: ${{ env.USER }}
          port: ${{ env.PORT }}
          key_path: ${{ github.workspace }}/.ssh/sftp_key
          source: "${{ env.ARTIFACT }}/"
          target: ${{ env.TARGET_DIR }}
          overwrite: true
